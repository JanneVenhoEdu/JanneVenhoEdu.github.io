<!DOCTYPE html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
		<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
		<link rel="stylesheet" href="esitysmuoto_pieni.css">
		<script>
			$(document).ready(function(){
				$(window).on('beforeunload', function() {
					$(window).scrollTop(0);
				});
				var kutsuja = document.referrer;
				if (kutsuja != ""){
					$("#kutsuja").html(kutsuja);
				}
				$("#urli").load(document.referrer + " #course-icon", () => etsiURL());
			});
		</script>
	</head>
	<body>
		<div style="display: none">
		\(
		   \def\euro{{\;\unicode{0x20AC}}}
		   \require{colorv2}
		\)
		</div>
		<div id="urli" style="display: none"></div>
		<div id="sisalto"></div>
		<div id="sisallysluettelo" style="display: none;"></div>
		<div id="navigointi" style="display: none;"></div>
		<p id="kutsuja">Kutsujaa ei löytynyt.</p>
		<script>
		// Muutetaan h5-otsikot h3-otsikoiksi
		function alusta(){
			var h5s = $("h5");
			for (var i = 0; i < h5s.length; i++){
				$("h5:first").replaceWith("<h3>" + h5s[i].innerHTML + "</h3>");
			}
			// Skaalataan GeoGebra-upotukset 300px leveiksi.
			// Haetaan GG-upotukset ja ikkunan leveys
			var upotukset = $(".gg_upotus");
			var widthWin = $(window).width();
			// Muutetaan kaikkien upotusten kokoa
			for (var i = 0; i < upotukset.length; i++){
				// Upotuksen alkuperäiset mitat ja korkeuden ja leveyden suhde.
				var width = Number($(upotukset.get(i)).width());
				var height = Number($(upotukset.get(i)).height());
				var ratio = height/width;
				// Muutetaan upotuksen korkeudeksi 400px, jos tarve.
				if (height > 400){
					var height = 400;
					var width = Math.round(400/ratio);
				}
				// Kavennetaan 90% ikkunan leveydestä, jos tarve.
				if (width > 0.9*widthWin){
					width = 0.9*widthWin;
					height = ratio*width;
				}
				$(upotukset.get(i)).css({"width": String(width + "px"), "height": String(height + "px")});
			}
			$("img").each(function(){
				var leveys = $(this).css("width").replace("px", "");
				var korkeus = $(this).css("height").replace("px", "");
				var leveysIkkuna = $(window).width();
				if (korkeus > 400){
				  $(this).css({"height":"400", "width":"auto"});
				}
				var leveys = $(this).css("width").replace("px", "");
				if (leveys > 0.9*leveysIkkuna){
				  $(this).css({"width":0.9*leveysIkkuna, "height": "auto"});
				}
			});
			MathJax.typeset();
		}
		// Etsitään etusivun url-osoite
		function etsiURL(){
			var etusivunURL = document.getElementById("course-icon").getAttribute("href");
			$("#navigointi").load(etusivunURL + " #section-0", () => etsiID());
		}
		// Etsitään kirjan ID-numero
		function etsiID(){
			var kirjanID = document.getElementsByClassName("activity book")[0].getAttribute("id").replace("module-", "");
			$("#sisallysluettelo").load("https://reppu.mmg.fi/mod/book/view.php?id=" + kirjanID + " #block-region-side-pre", () => pura(kirjanID));
		}
		// Puretaan kirjan otsikkotiedot
		function pura(kirjanID){
			var sisallysluettelo = document.getElementsByClassName("text-truncate");
			if (sisallysluettelo.length == 0){
				var lista = document.getElementsByTagName("ul")[0];
				var linkit = lista.getElementsByTagName("a");
				var otsikot = [lista.getElementsByTagName("strong")[0].innerHTML];
				var tunnisteet = [otsikot[0].replace("1. ", "").toLowerCase().replace(/\s/g, "_").replace(/\:/,"").replace(/ä/g,"a").replace(/ö/g,"o")];
				var lukuLista = [,];
				for (var i = 0; i < linkit.length; i++){
					otsikot[i+1] = linkit[i].innerHTML;
					tunnisteet[i+1] = linkit[i].getAttribute("title").toLowerCase().replace(/\s/g, "_").replace(/\:/,"").replace(/ä/g,"a").replace(/ö/g,"o");
					lukuLista[i+1] = linkit[i].href.replace("https://reppu.mmg.fi/mod/book/view.php?id=" + kirjanID + "&chapterid=", "");
				}
			} else {
				var otsikot = [];
				var tunnisteet = [sisallysluettelo[0].innerHTML.replace("1. ", "").toLowerCase().replace(/\s/g, "_").replace(/\:/,"").replace(/ä/g,"a").replace(/ö/g,"o")];
				var lukuLista = [,];
				for (var i = 0; i < sisallysluettelo.length; i++){
					otsikot[i] = sisallysluettelo[i].innerHTML;
					if (i > 0){
						tunnisteet[i] = sisallysluettelo[i].getAttribute("title").toLowerCase().replace(/\s/g, "_").replace(/\:/,"").replace(/ä/g,"a").replace(/ö/g,"o");
						lukuLista[i] = sisallysluettelo[i].href.replace("https://reppu.mmg.fi/mod/book/view.php?id=" + kirjanID + "&chapterid=", "");
					}
				}
			}
			var sisalto = "";
			var tunnistaAlaluku = /\d+\.\d+\./;
			for (var i = 0; i < otsikot.length; i++){
				if (tunnistaAlaluku.test(otsikot[i])){
					sisalto = sisalto + "<h2>" + otsikot[i] + "</h2><div id=\"" + tunnisteet[i] + "\"></div>";
				} else {
					sisalto = sisalto + "<h1>" + otsikot[i] + "</h1><div id=\"" + tunnisteet[i] + "\"></div>";
				}
			}
			document.getElementById("sisalto").innerHTML = sisalto;
			$("#"+tunnisteet[0]).load("https://reppu.mmg.fi/mod/book/view.php?id=" + kirjanID + " #esitys", () => alusta());
			for (var i = 1; i < tunnisteet.length; i++){
				$("#" + tunnisteet[i]).load("https://reppu.mmg.fi/mod/book/view.php?id=" + kirjanID + "&chapterid=" + lukuLista[i] + " #esitys", () => alusta());
			}
			$("h1").click(function(){
				$(this).nextAll("div:first").slideToggle("slow");
			});
			$("h2").click(function(){
				$(this).nextAll("div:first").slideToggle("slow");
			});
			$("div").hide();
			$("#sisalto").show();
		}
		</script>
	</body>
</html>